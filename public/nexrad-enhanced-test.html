<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß NEXRAD Weather Radar - Enhanced Debug Test</title>

    <!-- OpenLayers CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@8.2.0/ol.css" type="text/css">

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #001122;
            color: white;
        }

        .header {
            background: #002244;
            padding: 15px;
            border-bottom: 2px solid #0066cc;
        }

        .header h1 {
            margin: 0;
            color: #00aaff;
        }

        .container {
            display: flex;
            height: calc(100vh - 80px);
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .sidebar {
            width: 350px;
            background: #001a33;
            padding: 20px;
            overflow-y: auto;
            border-left: 2px solid #0066cc;
        }

        .control-section {
            margin-bottom: 25px;
            padding: 15px;
            background: #002244;
            border-radius: 8px;
            border: 1px solid #0066cc;
        }

        .control-section h3 {
            margin: 0 0 15px 0;
            color: #00aaff;
            border-bottom: 1px solid #0066cc;
            padding-bottom: 8px;
        }

        button {
            background: #0066cc;
            border: none;
            color: white;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background: #0088ff;
        }

        button.success {
            background: #00aa00;
        }

        button.warning {
            background: #ff8800;
        }

        button.danger {
            background: #aa0000;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }

        .status.success {
            background: #002200;
            border: 1px solid #00aa00;
            color: #00ff00;
        }

        .status.warning {
            background: #332200;
            border: 1px solid #ff8800;
            color: #ffaa00;
        }

        .status.error {
            background: #220000;
            border: 1px solid #aa0000;
            color: #ff4444;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            z-index: 1000;
        }

        .spinner {
            border: 3px solid #333;
            border-top: 3px solid #00aaff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .log {
            background: #000011;
            border: 1px solid #0066cc;
            border-radius: 5px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 11px;
            white-space: pre-wrap;
        }

        .layer-toggle {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }

        .layer-toggle input {
            margin-right: 10px;
        }

        .layer-toggle label {
            flex: 1;
            cursor: pointer;
        }

        .opacity-control {
            margin: 10px 0;
        }

        .opacity-control input {
            width: 100%;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîß NEXRAD Weather Radar - Enhanced Debug Test</h1>
        <p>Comprehensive validation and testing of radar data sources</p>
    </div>

    <div class="container">
        <div class="map-container">
            <div id="map"></div>
            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <div id="loading-text">Initializing radar system...</div>
            </div>
        </div>

        <div class="sidebar">
            <div class="control-section">
                <h3>üõ†Ô∏è System Diagnostics</h3>
                <button onclick="testBasicJS()">Test Basic JS</button>
                <button onclick="testOpenLayers()">Test OpenLayers</button>
                <button onclick="runFullDiagnostics()">Run Full Diagnostics</button>
                <button onclick="testNEXRADEndpoints()">Test NEXRAD Sources</button>
                <button onclick="validateLayerConfig()">Validate Layers</button>
                <button onclick="checkRadarController()">Check Controller Status</button>
                <div id="diagnostic-status" class="status">Ready for testing</div>
            </div>

            <div class="control-section">
                <h3>üì° Radar Controls</h3>
                <div id="layer-controls">
                    <!-- Dynamic layer controls will be inserted here -->
                </div>
                <div class="opacity-control">
                    <label for="radar-opacity">Radar Opacity:</label>
                    <input type="range" id="radar-opacity" min="0" max="100" value="70" onchange="updateRadarOpacity(this.value)">
                    <span id="opacity-value">70%</span>
                </div>
            </div>

            <div class="control-section">
                <h3>üìä Performance Stats</h3>
                <div id="performance-stats" class="status">
                    <div>Tiles Loaded: <span id="tiles-loaded">0</span></div>
                    <div>Success Rate: <span id="success-rate">N/A</span></div>
                    <div>Active Source: <span id="active-source">None</span></div>
                    <div>Last Error: <span id="last-error">None</span></div>
                </div>
            </div>

            <div class="control-section">
                <h3>üìù Debug Log</h3>
                <div id="debug-log" class="log">System ready...\n</div>
                <button onclick="clearLog()">Clear Log</button>
                <button onclick="exportLog()">Export Log</button>
            </div>
        </div>
    </div>

    <!-- OpenLayers and Application Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/ol@8.2.0/dist/ol.js"></script>
    <script>
        // Basic debug to verify script is loading
        console.log('üöÄ Script started loading...');

        // Test basic functionality immediately
        try {
            document.getElementById('debug-log').textContent += '[INIT] JavaScript is loading...\n';
        } catch (e) {
            console.error('Cannot access debug-log element:', e);
        }

        // Global variables for debugging
        window.weatherRadar = null;
        window.radarController = null;
        window.layerManager = null;
        window.map = null;

        // Debug logging function
        function debugLog(message, type = 'info') {
            const timestamp = new Date().toISOString().substr(11, 8);
            const logElement = document.getElementById('debug-log');
            const prefix = type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        // Override console methods to capture logs
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        console.log = (...args) => {
            originalLog(...args);
            debugLog(args.join(' '), 'info');
        };

        console.error = (...args) => {
            originalError(...args);
            debugLog(args.join(' '), 'error');
        };

        console.warn = (...args) => {
            originalWarn(...args);
            debugLog(args.join(' '), 'warning');
        };

        // Wait for OpenLayers to load, then dynamically import modules
        function waitForOpenLayers() {
            return new Promise((resolve, reject) => {
                if (typeof ol !== 'undefined') {
                    debugLog('‚úÖ OpenLayers already loaded', 'success');
                    resolve();
                    return;
                }

                let attempts = 0;
                const maxAttempts = 50; // 5 seconds
                const checkInterval = setInterval(() => {
                    attempts++;
                    if (typeof ol !== 'undefined') {
                        clearInterval(checkInterval);
                        debugLog('‚úÖ OpenLayers loaded after waiting', 'success');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        debugLog('‚ùå OpenLayers failed to load after timeout', 'error');
                        reject(new Error('OpenLayers loading timeout'));
                    }
                }, 100);
            });
        }

        // Initialize application after OpenLayers is ready
        async function initializeApplication() {
            try {
                debugLog('üöÄ Starting Enhanced Radar Test Application');

                // Wait for OpenLayers to be ready
                await waitForOpenLayers();

                showLoading('Initializing application...');

                // Create map
                debugLog('Creating OpenLayers map...');
                window.map = new ol.Map({
                    target: 'map',
                    view: new ol.View({
                        center: ol.proj.fromLonLat([-98.5795, 39.8283]), // Center of US
                        zoom: 5,
                        minZoom: 3,
                        maxZoom: 15
                    })
                });
                debugLog('‚úÖ Map created successfully', 'success');

                // Now dynamically import and initialize modules
                showLoading('Loading modules...');
                debugLog('Importing LayerManager module...');

                const { LayerManager } = await import('../src/modules/layer-manager.js');
                debugLog('‚úÖ LayerManager imported', 'success');

                debugLog('Importing RadarController module...');
                const { RadarController } = await import('../src/modules/radar-controller.js');
                debugLog('‚úÖ RadarController imported', 'success');

                // Initialize layer manager
                showLoading('Initializing layer manager...');
                debugLog('Creating LayerManager instance...');
                window.layerManager = new LayerManager(window.map, { debug: true });
                debugLog('LayerManager created, calling init()...');
                await window.layerManager.init();
                debugLog('‚úÖ LayerManager initialized', 'success');

                // Initialize radar controller with debug mode
                showLoading('Initializing radar controller...');
                debugLog('Creating RadarController instance...');
                window.radarController = new RadarController(window.map, window.layerManager, { debug: true });
                debugLog('RadarController created, calling init()...');
                await window.radarController.init();
                debugLog('‚úÖ RadarController initialized', 'success');

                // Set up event listeners
                setupEventListeners();

                // Create layer controls
                createLayerControls();

                // Update performance stats periodically
                setInterval(updatePerformanceStats, 3000);

                hideLoading();
                debugLog('‚úÖ Application initialized successfully', 'success');

                // Run initial diagnostics
                setTimeout(() => {
                    debugLog('Running initial diagnostics...');
                    runFullDiagnostics();
                }, 2000);

            } catch (error) {
                hideLoading();
                debugLog(`‚ùå Failed to initialize application: ${error.message}`, 'error');
                console.error('Full error:', error);
                showStatus('Application initialization failed: ' + error.message, 'error');
            }
        }

        function setupEventListeners() {
            if (window.radarController) {
                window.radarController.addEventListener('radar:validation-complete', (event) => {
                    debugLog('Radar validation completed', 'success');
                    updateDiagnosticStatus(event.detail);
                });

                window.radarController.addEventListener('radar:initialized', () => {
                    debugLog('Radar controller initialized', 'success');
                });
            }
        }

        function createLayerControls() {
            const container = document.getElementById('layer-controls');
            if (!window.layerManager) return;

            const radarLayers = window.layerManager.getLayerGroup('radar') || [];

            radarLayers.forEach((layer, index) => {
                const toggle = document.createElement('div');
                toggle.className = 'layer-toggle';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `layer-${index}`;
                checkbox.checked = layer.getVisible();
                checkbox.onchange = () => {
                    layer.setVisible(checkbox.checked);
                    debugLog(`Layer "${layer.get('name')}" ${checkbox.checked ? 'enabled' : 'disabled'}`);
                };

                const label = document.createElement('label');
                label.htmlFor = `layer-${index}`;
                label.textContent = layer.get('name') || `Layer ${index + 1}`;

                toggle.appendChild(checkbox);
                toggle.appendChild(label);
                container.appendChild(toggle);
            });
        }

        function showLoading(text) {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loading-text').textContent = text;
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showStatus(message, type = 'info') {
            const statusElement = document.getElementById('diagnostic-status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        function updateDiagnosticStatus(results) {
            const available = results.results.filter(r => r.available).length;
            const total = results.results.length;
            const selected = results.selectedSource?.name || 'None';

            showStatus(`Sources: ${available}/${total} available. Active: ${selected}`,
                      available > 0 ? 'success' : 'error');
        }

        function updatePerformanceStats() {
            if (!window.radarController) return;

            const stats = window.radarController.getTileLoadingStatus();
            document.getElementById('tiles-loaded').textContent = `${stats.successful}/${stats.attempted}`;
            document.getElementById('success-rate').textContent = stats.successRate;
            document.getElementById('active-source').textContent = stats.currentSource;
            document.getElementById('last-error').textContent = stats.lastError || 'None';
        }

        // Simple test functions that don't depend on modules
        window.testBasicJS = function() {
            debugLog('‚úÖ Basic JavaScript is working!');
            debugLog('Document ready state: ' + document.readyState);
            debugLog('OpenLayers type: ' + typeof ol);
        };

        // Global functions for UI
        window.runFullDiagnostics = async function() {
            debugLog('üîß runFullDiagnostics button clicked');
            if (!window.radarController) {
                debugLog('Radar controller not initialized', 'error');
                showStatus('Radar controller not ready', 'error');
                return;
            }

            debugLog('üîß Running comprehensive diagnostics...');
            showLoading('Running diagnostics...');

            try {
                const results = await window.radarController.runDiagnostics();
                hideLoading();
                debugLog(`‚úÖ Diagnostics completed: ${results.availableSources}/${results.totalSources} sources available`, 'success');
                showStatus(`Diagnostics complete: ${results.availableSources}/${results.totalSources} sources available`, 'success');
            } catch (error) {
                hideLoading();
                debugLog(`‚ùå Diagnostics failed: ${error.message}`, 'error');
                showStatus(`Diagnostics failed: ${error.message}`, 'error');
            }
        };

        window.testNEXRADEndpoints = async function() {
            debugLog('üß™ testNEXRADEndpoints button clicked');
            if (!window.radarController) {
                debugLog('Radar controller not initialized', 'error');
                showStatus('Radar controller not ready', 'error');
                return;
            }

            debugLog('üß™ Testing NEXRAD endpoints...');
            showLoading('Testing endpoints...');

            try {
                const results = await window.radarController.validateNEXRADEndpoints();
                hideLoading();
                debugLog(`‚úÖ Endpoint test completed: ${results.filter(r => r.available).length} working`, 'success');
                showStatus(`Endpoint test complete: ${results.filter(r => r.available).length} working`, 'success');
            } catch (error) {
                hideLoading();
                debugLog(`‚ùå Endpoint test failed: ${error.message}`, 'error');
                showStatus(`Endpoint test failed: ${error.message}`, 'error');
            }
        };

        window.validateLayerConfig = async function() {
            debugLog('üîç validateLayerConfig button clicked');
            if (!window.radarController) {
                debugLog('Radar controller not initialized', 'error');
                showStatus('Radar controller not ready', 'error');
                return;
            }

            debugLog('üîç Validating layer configuration...');
            showLoading('Validating layers...');

            try {
                const result = await window.radarController.testLayerConfiguration();
                hideLoading();
                debugLog(`${result ? '‚úÖ Layer configuration valid' : '‚ùå Layer configuration invalid'}`,
                        result ? 'success' : 'error');
                showStatus(`Layer config ${result ? 'valid' : 'invalid'}`, result ? 'success' : 'error');
            } catch (error) {
                hideLoading();
                debugLog(`‚ùå Layer validation failed: ${error.message}`, 'error');
                showStatus(`Layer validation failed: ${error.message}`, 'error');
            }
        };

        window.updateRadarOpacity = function(value) {
            debugLog(`updateRadarOpacity called with value: ${value}`);
            document.getElementById('opacity-value').textContent = value + '%';
            const opacity = value / 100;

            if (window.layerManager) {
                const radarLayers = window.layerManager.getLayerGroup('radar') || [];
                radarLayers.forEach(layer => layer.setOpacity(opacity));
                debugLog(`Updated radar opacity to ${value}%`);
            } else {
                debugLog('LayerManager not available', 'warning');
            }
        };

        window.clearLog = function() {
            debugLog('clearLog called');
            document.getElementById('debug-log').textContent = 'Log cleared...\n';
        };

        window.exportLog = function() {
            debugLog('exportLog called');
            const log = document.getElementById('debug-log').textContent;
            const blob = new Blob([log], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `nexrad-debug-${new Date().toISOString().substr(0, 10)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        };

        // Debug function to check what methods are available
        window.checkRadarController = function() {
            debugLog('=== Radar Controller Status ===');
            debugLog(`window.radarController exists: ${!!window.radarController}`);
            if (window.radarController) {
                debugLog(`runDiagnostics method: ${typeof window.radarController.runDiagnostics}`);
                debugLog(`validateNEXRADEndpoints method: ${typeof window.radarController.validateNEXRADEndpoints}`);
                debugLog(`testLayerConfiguration method: ${typeof window.radarController.testLayerConfiguration}`);
            }
            debugLog('========================');
        };

        // Simple test function to verify OpenLayers works
        window.testOpenLayers = function() {
            debugLog('üß™ Testing basic OpenLayers functionality...');
            try {
                if (typeof ol === 'undefined') {
                    debugLog('‚ùå OpenLayers not loaded', 'error');
                    return;
                }

                debugLog('‚úÖ OpenLayers is available', 'success');
                debugLog(`OpenLayers version: ${ol.util.VERSION || 'unknown'}`);

                // Test creating a simple map
                const testMap = new ol.Map({
                    target: 'map',
                    layers: [
                        new ol.layer.Tile({
                            source: new ol.source.OSM()
                        })
                    ],
                    view: new ol.View({
                        center: ol.proj.fromLonLat([-98.5795, 39.8283]),
                        zoom: 5
                    })
                });

                debugLog('‚úÖ Basic OpenLayers map created successfully', 'success');
                window.map = testMap;

            } catch (error) {
                debugLog(`‚ùå OpenLayers test failed: ${error.message}`, 'error');
                console.error('OpenLayers test error:', error);
            }
        };

        // Start the application when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('DOM loaded, starting initialization...');
            initializeApplication();
        });
    </script>
</body>
</html>
