<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXRAD Radar Visualization</title>

    <!-- OpenLayers -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@8.2.0/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@8.2.0/dist/ol.js"></script>

    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { width: 100%; height: 100vh; }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s;
        }

        .progress-container {
            width: 300px;
            background: #333;
            border-radius: 4px;
            padding: 4px;
            margin: 20px 0;
        }

        .progress-bar {
            height: 20px;
            background: #00ff00;
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 0;
        }

        .loading-status {
            font-size: 16px;
            margin-top: 10px;
        }

        .controls {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 4px;
            z-index: 1000;
        }

        button {
            background: #444;
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div id="loading-screen" class="loading-screen">
        <h2>Loading Weather Radar</h2>
        <div class="progress-container">
            <div id="progress-bar" class="progress-bar"></div>
        </div>
        <div id="loading-status" class="loading-status">Initializing...</div>
    </div>

    <div class="controls">
        <button onclick="window.weatherMap.toggleRadar()">Toggle Radar</button>
        <button onclick="window.weatherMap.reloadRadar()">Reload Radar</button>
    </div>

    <script>
        // Initialize global state
        window.weatherMap = {
            map: null,
            radarLayer: null,
            tileStats: {
                loaded: 0,
                errors: 0,
                lastError: null
            },
            loading: {
                screen: document.getElementById('loading-screen'),
                progressBar: document.getElementById('progress-bar'),
                status: document.getElementById('loading-status')
            },
            updateProgress: function(percent, message) {
                if (this.loading.progressBar) {
                    this.loading.progressBar.style.width = percent + '%';
                }
                if (this.loading.status) {
                    this.loading.status.textContent = message;
                }
            },
            showError: function(error) {
                console.error('Error:', error);
                if (this.loading.status) {
                    this.loading.status.innerHTML = `
                        <div style="color: #ff0000">
                            Error: ${error.message || error}<br>
                            <button onclick="window.location.reload()">Retry</button>
                        </div>`;
                }
            },
            hideLoading: function() {
                if (this.loading.screen) {
                    this.loading.screen.style.opacity = '0';
                    setTimeout(() => {
                        this.loading.screen.style.display = 'none';
                    }, 500);
                }
            },
            toggleRadar: function() {
                if (this.radarLayer) {
                    this.radarLayer.setVisible(!this.radarLayer.getVisible());
                }
            },
            reloadRadar: function() {
                if (this.radarLayer) {
                    this.updateProgress(0, 'Reloading radar...');
                    this.loading.screen.style.display = 'flex';
                    this.loading.screen.style.opacity = '1';
                    this.tileStats.loaded = 0;
                    this.tileStats.errors = 0;
                    this.radarLayer.getSource().refresh();
                    setTimeout(() => this.hideLoading(), 1000);
                }
            }
        };

        // Initialize the map and radar layer
        async function initializeSystem() {
            try {
                // Check dependencies
                weatherMap.updateProgress(10, 'Checking dependencies...');
                if (typeof ol === 'undefined') {
                    throw new Error('OpenLayers not loaded');
                }

                // Initialize map
                weatherMap.updateProgress(30, 'Initializing map...');
                weatherMap.map = new ol.Map({
                    target: 'map',
                    view: new ol.View({
                        center: ol.proj.fromLonLat([-98.5795, 39.8283]),
                        zoom: 4
                    })
                });

                // Add base layer
                weatherMap.updateProgress(50, 'Setting up base layer...');
                const osmLayer = new ol.layer.Tile({
                    source: new ol.source.OSM()
                });
                weatherMap.map.addLayer(osmLayer);

                // Add radar layer
                weatherMap.updateProgress(70, 'Initializing radar...');
                const radarSource = new ol.source.XYZ({
                    url: 'https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/nexrad-n0q-900913/{z}/{x}/{y}.png',
                    attributions: 'Â© Iowa Environmental Mesonet',
                    crossOrigin: 'anonymous'
                });

                // Track tile loading
                radarSource.on('tileloadstart', () => {
                    console.log('Loading radar tile...');
                });

                radarSource.on('tileloadend', () => {
                    weatherMap.tileStats.loaded++;
                    console.log('Radar tile loaded successfully');
                });

                radarSource.on('tileloaderror', (error) => {
                    weatherMap.tileStats.errors++;
                    weatherMap.tileStats.lastError = 'Failed to load tile';
                    console.error('Failed to load radar tile:', error);
                });

                weatherMap.radarLayer = new ol.layer.Tile({
                    source: radarSource,
                    opacity: 0.7
                });

                weatherMap.map.addLayer(weatherMap.radarLayer);

                // Complete initialization
                weatherMap.updateProgress(100, 'Ready!');
                setTimeout(() => weatherMap.hideLoading(), 1000);

            } catch (error) {
                console.error('Initialization failed:', error);
                weatherMap.showError(error);
            }
        }

        // Initialize on page load
        window.addEventListener('load', initializeSystem);

        // Global error handler
        window.onerror = function(msg, url, line, col, error) {
            console.error('Global error:', { msg, url, line, col, error });
            weatherMap.showError(msg);
            return false;
        };
    </script>
</body>
</html>
