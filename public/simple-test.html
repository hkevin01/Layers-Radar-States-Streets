<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple OpenLayers Test</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@8.2.0/ol.css" type="text/css">
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #map { width: 100%; height: 400px; }
        #controls { padding: 20px; background: #f0f0f0; }
        button { padding: 10px; margin: 5px; cursor: pointer; }
        #log { background: #000; color: #0f0; padding: 10px; font-family: monospace; height: 200px; overflow-y: auto; }
        #stats {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .loading-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .loading-indicator.active { background: #0f0; }
        .loading-indicator.error { background: #f00; }
        .loading-indicator.idle { background: #666; }
        .diagnostic-section {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="controls">
        <h2>Simple OpenLayers Test</h2>
        <button onclick="testBasicJS()">Test Basic JavaScript</button>
        <button onclick="testOpenLayers()">Test OpenLayers</button>
        <button onclick="testMap()">Create Map</button>
        <button onclick="testRadar()">Test Radar Layer</button>
        <button onclick="clearLog()">Clear Log</button>
        <div class="opacity-control">
            <label for="opacity">Radar Opacity:</label>
            <input type="range" id="opacity" min="0" max="100" value="70" oninput="updateOpacity(this.value)">
            <span id="opacity-value">70%</span>
        </div>
    </div>

    <div id="map"></div>

    <div id="stats">
        <div class="diagnostic-section">
            <div><span class="loading-indicator idle" id="radar-status"></span> Radar Status: <span id="radar-status-text">Idle</span></div>
            <div>Tiles Loaded: <span id="tiles-loaded">0</span>/<span id="tiles-total">0</span></div>
            <div>Success Rate: <span id="success-rate">N/A</span></div>
            <div>Active Source: <span id="active-source">None</span></div>
            <div>Last Error: <span id="last-error">None</span></div>
        </div>
    </div>

    <div id="log">Ready...\n</div>

    <script src="https://cdn.jsdelivr.net/npm/ol@8.2.0/dist/ol.js"></script>
    <script>
        function log(message) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toISOString().substr(11, 8);
            logEl.textContent += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }

        window.testBasicJS = function() {
            log('✅ Basic JavaScript is working!');
            log('Document ready: ' + (document.readyState === 'complete'));
        };

        window.testOpenLayers = function() {
            log('Testing OpenLayers...');
            if (typeof ol === 'undefined') {
                log('❌ OpenLayers not loaded');
            } else {
                log('✅ OpenLayers is available');
                log('OpenLayers version: ' + (ol.util?.VERSION || 'unknown'));
            }
        };

        // Global variables
        window.radarLayer = null;
        window.baseLayer = null;
        window.radarStats = {
            tilesLoaded: 0,
            tilesTotal: 0,
            tilesError: 0,
            activeSource: 'None',
            lastError: 'None',
            loadingTiles: new Set()
        };

        const RADAR_SOURCES = [
            {
                id: 'iem-nexrad',
                name: 'IEM NEXRAD',
                url: 'https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/nexrad-n0q/{z}/{x}/{y}.png'
            },
            {
                id: 'weather-gov',
                name: 'Weather.gov',
                url: 'https://nowcoast.noaa.gov/arcgis/rest/services/nowcoast/radar_meteo_imagery_nexrad_time/MapServer/tile/{z}/{y}/{x}'
            }
        ];

        function updateStats() {
            const stats = window.radarStats;
            document.getElementById('tiles-loaded').textContent = stats.tilesLoaded;
            document.getElementById('tiles-total').textContent = stats.tilesTotal;
            document.getElementById('success-rate').textContent =
                stats.tilesTotal > 0 ?
                Math.round((stats.tilesLoaded / stats.tilesTotal) * 100) + '%' :
                'N/A';
            document.getElementById('active-source').textContent = stats.activeSource;
            document.getElementById('last-error').textContent = stats.lastError;

            const indicator = document.getElementById('radar-status');
            const statusText = document.getElementById('radar-status-text');

            if (stats.loadingTiles.size > 0) {
                indicator.className = 'loading-indicator active';
                statusText.textContent = 'Loading';
            } else if (stats.tilesError > stats.tilesLoaded && stats.tilesTotal > 0) {
                indicator.className = 'loading-indicator error';
                statusText.textContent = 'Error';
            } else if (stats.tilesLoaded > 0) {
                indicator.className = 'loading-indicator active';
                statusText.textContent = 'Active';
            } else {
                indicator.className = 'loading-indicator idle';
                statusText.textContent = 'Idle';
            }
        }

        async function validateRadarSource(source) {
            log(`Validating radar source: ${source.name}...`);
            try {
                const testTile = source.url
                    .replace('{z}', '6')
                    .replace('{x}', '20')
                    .replace('{y}', '20');

                const response = await fetch(testTile, { method: 'HEAD' });
                const valid = response.ok &&
                    (response.headers.get('content-type') || '').includes('image');

                log(valid ?
                    `✅ ${source.name} is accessible` :
                    `❌ ${source.name} validation failed`);

                return valid;
            } catch (error) {
                log(`❌ ${source.name} validation failed: ${error.message}`);
                return false;
            }
        }

        window.testMap = function() {
            log('Creating OpenLayers map...');
            try {
                // Create base layer
                window.baseLayer = new ol.layer.Tile({
                    source: new ol.source.OSM()
                });

                const map = new ol.Map({
                    target: 'map',
                    layers: [window.baseLayer],
                    view: new ol.View({
                        center: ol.proj.fromLonLat([-98.5795, 39.8283]),
                        zoom: 4
                    })
                });
                log('✅ Map created successfully!');
                window.testMapInstance = map;
            } catch (error) {
                log('❌ Map creation failed: ' + error.message);
                console.error(error);
            }
        };

        window.testRadar = async function() {
            log('Testing NEXRAD radar layer...');
            try {
                if (!window.testMapInstance) {
                    log('❌ Please create map first!');
                    return;
                }

                // Reset stats
                window.radarStats = {
                    tilesLoaded: 0,
                    tilesTotal: 0,
                    tilesError: 0,
                    activeSource: 'None',
                    lastError: 'None',
                    loadingTiles: new Set()
                };
                updateStats();

                // Remove existing radar layer if any
                if (window.radarLayer) {
                    window.testMapInstance.removeLayer(window.radarLayer);
                    window.radarLayer = null;
                }

                // Validate radar sources
                let validSource = null;
                for (const source of RADAR_SOURCES) {
                    if (await validateRadarSource(source)) {
                        validSource = source;
                        break;
                    }
                }

                if (!validSource) {
                    throw new Error('No valid radar sources found');
                }

                log(`Using radar source: ${validSource.name}`);
                window.radarStats.activeSource = validSource.name;

                // Create new radar layer
                window.radarLayer = new ol.layer.Tile({
                    source: new ol.source.XYZ({
                        url: validSource.url,
                        crossOrigin: 'anonymous',
                        tileLoadFunction: function(tile, src) {
                            const tileId = src;
                            window.radarStats.loadingTiles.add(tileId);
                            window.radarStats.tilesTotal++;
                            updateStats();

                            const image = tile.getImage();
                            image.addEventListener('load', function() {
                                window.radarStats.tilesLoaded++;
                                window.radarStats.loadingTiles.delete(tileId);
                                updateStats();
                            });

                            image.addEventListener('error', function() {
                                window.radarStats.tilesError++;
                                window.radarStats.loadingTiles.delete(tileId);
                                updateStats();
                            });

                            image.src = src;
                        }
                    }),
                    opacity: 0.7
                });

                // Add radar layer to map
                window.testMapInstance.addLayer(window.radarLayer);
                log('✅ Radar layer added successfully!');

                // Test tile loading
                window.radarLayer.getSource().on('tileloadstart', function(event) {
                    const tile = event.tile;
                    const tileCoord = tile.tileCoord;
                    log(`🔄 Loading radar tile [${tileCoord[0]}, ${tileCoord[1]}, ${tileCoord[2]}]`);
                });

                window.radarLayer.getSource().on('tileloadend', function(event) {
                    const tile = event.tile;
                    const tileCoord = tile.tileCoord;
                    log(`✅ Radar tile loaded [${tileCoord[0]}, ${tileCoord[1]}, ${tileCoord[2]}]`);
                });

                window.radarLayer.getSource().on('tileloaderror', function(event) {
                    const tile = event.tile;
                    const tileCoord = tile.tileCoord;
                    const error = `Failed to load tile [${tileCoord[0]}, ${tileCoord[1]}, ${tileCoord[2]}]`;
                    log(`❌ ${error}`);
                    window.radarStats.lastError = error;
                    updateStats();
                });

            } catch (error) {
                log('❌ Radar layer creation failed: ' + error.message);
                console.error(error);
            }
        };

        window.updateOpacity = function(value) {
            if (window.radarLayer) {
                const opacity = value / 100;
                window.radarLayer.setOpacity(opacity);
                document.getElementById('opacity-value').textContent = value + '%';
                log(`Updated radar opacity to ${value}%`);
            } else {
                log('❌ No radar layer to update');
            }
        };

        window.clearLog = function() {
            document.getElementById('log').textContent = 'Log cleared...\n';
        };

        // Test on load
        document.addEventListener('DOMContentLoaded', function() {
            log('DOM loaded');
            setTimeout(() => {
                testBasicJS();
                testOpenLayers();
            }, 100);
        });
    </script>
</body>
</html>
