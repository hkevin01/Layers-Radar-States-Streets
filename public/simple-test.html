<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple OpenLayers Test</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@8.2.0/ol.css" type="text/css">
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #map { width: 100%; height: 400px; }
        #controls { padding: 20px; background: #f0f0f0; }
        button { padding: 10px; margin: 5px; cursor: pointer; }
        #log { background: #000; color: #0f0; padding: 10px; font-family: monospace; height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div id="controls">
        <h2>Simple OpenLayers Test</h2>
        <button onclick="testBasicJS()">Test Basic JavaScript</button>
        <button onclick="testOpenLayers()">Test OpenLayers</button>
        <button onclick="testMap()">Create Map</button>
        <button onclick="testRadar()">Test Radar Layer</button>
        <button onclick="clearLog()">Clear Log</button>
        <div class="opacity-control">
            <label for="opacity">Radar Opacity:</label>
            <input type="range" id="opacity" min="0" max="100" value="70" oninput="updateOpacity(this.value)">
            <span id="opacity-value">70%</span>
        </div>
    </div>

    <div id="map"></div>

    <div id="log">Ready...\n</div>

    <script src="https://cdn.jsdelivr.net/npm/ol@8.2.0/dist/ol.js"></script>
    <script>
        function log(message) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toISOString().substr(11, 8);
            logEl.textContent += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }

        window.testBasicJS = function() {
            log('✅ Basic JavaScript is working!');
            log('Document ready: ' + (document.readyState === 'complete'));
        };

        window.testOpenLayers = function() {
            log('Testing OpenLayers...');
            if (typeof ol === 'undefined') {
                log('❌ OpenLayers not loaded');
            } else {
                log('✅ OpenLayers is available');
                log('OpenLayers version: ' + (ol.util?.VERSION || 'unknown'));
            }
        };

        // Global variables
        window.radarLayer = null;
        window.baseLayer = null;

        window.testMap = function() {
            log('Creating OpenLayers map...');
            try {
                // Create base layer
                window.baseLayer = new ol.layer.Tile({
                    source: new ol.source.OSM()
                });

                const map = new ol.Map({
                    target: 'map',
                    layers: [window.baseLayer],
                    view: new ol.View({
                        center: ol.proj.fromLonLat([-98.5795, 39.8283]),
                        zoom: 4
                    })
                });
                log('✅ Map created successfully!');
                window.testMapInstance = map;
            } catch (error) {
                log('❌ Map creation failed: ' + error.message);
                console.error(error);
            }
        };

        window.testRadar = function() {
            log('Testing NEXRAD radar layer...');
            try {
                if (!window.testMapInstance) {
                    log('❌ Please create map first!');
                    return;
                }

                // Remove existing radar layer if any
                if (window.radarLayer) {
                    window.testMapInstance.removeLayer(window.radarLayer);
                    window.radarLayer = null;
                }

                // Create new radar layer
                window.radarLayer = new ol.layer.Tile({
                    source: new ol.source.XYZ({
                        url: 'https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/nexrad-n0q/{z}/{x}/{y}.png',
                        crossOrigin: 'anonymous'
                    }),
                    opacity: 0.7
                });

                // Add radar layer to map
                window.testMapInstance.addLayer(window.radarLayer);
                log('✅ Radar layer added successfully!');

                // Test tile loading
                window.radarLayer.getSource().on('tileloadstart', function() {
                    log('🔄 Loading radar tiles...');
                });

                window.radarLayer.getSource().on('tileloadend', function() {
                    log('✅ Radar tile loaded successfully');
                });

                window.radarLayer.getSource().on('tileloaderror', function(event) {
                    log('❌ Radar tile load failed');
                    console.error('Tile error:', event);
                });

            } catch (error) {
                log('❌ Radar layer creation failed: ' + error.message);
                console.error(error);
            }
        };

        window.updateOpacity = function(value) {
            if (window.radarLayer) {
                const opacity = value / 100;
                window.radarLayer.setOpacity(opacity);
                document.getElementById('opacity-value').textContent = value + '%';
                log(`Updated radar opacity to ${value}%`);
            } else {
                log('❌ No radar layer to update');
            }
        };

        window.clearLog = function() {
            document.getElementById('log').textContent = 'Log cleared...\n';
        };

        // Test on load
        document.addEventListener('DOMContentLoaded', function() {
            log('DOM loaded');
            setTimeout(() => {
                testBasicJS();
                testOpenLayers();
            }, 100);
        });
    </script>
</body>
</html>
