<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXRAD Radar Diagnostics</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@8.2.0/ol.css">
    <style>
        body { margin: 0; font-family: Arial, sans-serif; background: #1a1a1a; color: #fff; }

        .container {
            display: grid;
            grid-template-columns: 300px 1fr;
            height: 100vh;
            gap: 1px;
            background: #333;
        }

        #map {
            width: 100%;
            height: 100%;
            background: #000;
        }

        #controls {
            background: #2a2a2a;
            padding: 20px;
            overflow-y: auto;
        }

        .debug-panel {
            margin-bottom: 20px;
            padding: 15px;
            background: #333;
            border-radius: 4px;
        }

        .debug-title {
            font-size: 14px;
            font-weight: bold;
            color: #00ff00;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-success { background: #00ff00; }
        .status-error { background: #ff0000; }
        .status-warning { background: #ffff00; }
        .status-loading {
            background: #00ff00;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        .diagnostic-value {
            font-family: monospace;
            font-size: 12px;
            color: #00ff00;
            margin: 5px 0;
            word-break: break-all;
        }

        .error-value {
            color: #ff0000;
        }

        .log-panel {
            background: #000;
            color: #00ff00;
            font-family: monospace;
            font-size: 12px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        button {
            background: #444;
            color: #fff;
            border: 1px solid #666;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 12px;
        }

        button:hover {
            background: #555;
        }

        .radar-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .opacity-control {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px 0;
        }

        .opacity-control input {
            flex: 1;
        }

        .opacity-value {
            width: 50px;
            text-align: right;
            color: #00ff00;
        }

        hr {
            border: none;
            border-top: 1px solid #444;
            margin: 15px 0;
        }

        .network-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .stat-box {
            background: #222;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }

        .stat-label {
            font-size: 10px;
            color: #888;
        }

        .stat-value {
            font-size: 16px;
            color: #00ff00;
            font-weight: bold;
        }

        .diagnostic-details {
            background: #222;
            padding: 10px;
            border-radius: 4px;
        }

        .diagnostic-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 12px;
        }

        .diagnostic-label {
            color: #888;
        }

        .source-list {
            margin: 10px 0;
        }

        .source-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: #222;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 12px;
        }

        .source-item .status-indicator {
            flex-shrink: 0;
        }

        .source-item .source-details {
            flex-grow: 1;
        }

        .source-meta {
            font-size: 10px;
            color: #888;
            margin-top: 4px;
        }

        .source-error {
            color: #ff0000;
            font-size: 10px;
            margin-top: 4px;
        }

        .status-idle {
            background: #666;
        }

        .test-button {
            padding: 4px 8px;
            font-size: 11px;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="controls">
            <div class="debug-panel">
                <div class="debug-title">
                    <span class="status-indicator" id="system-status"></span>
                    System Status
                </div>
                <div class="diagnostic-value" id="system-info">Initializing...</div>
            </div>

            <div class="debug-panel">
                <div class="debug-title">
                    <span class="status-indicator" id="radar-status"></span>
                    Radar Controls
                </div>
                <div class="radar-controls">
                    <button onclick="testRadarSources()">Test Radar Sources</button>
                    <button onclick="reloadRadarLayer()">Reload Radar Layer</button>
                    <button onclick="toggleRadar()">Toggle Radar</button>
                    <div class="opacity-control">
                        <label for="opacity">Opacity:</label>
                        <input type="range" id="opacity" min="0" max="100" value="70">
                        <span class="opacity-value" id="opacity-value">70%</span>
                    </div>
                </div>
            </div>

            <div class="debug-panel">
                <div class="debug-title">Network Statistics</div>
                <div class="network-stats">
                    <div class="stat-box">
                        <div class="stat-label">Tiles Loaded</div>
                        <div class="stat-value" id="tiles-loaded">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Success Rate</div>
                        <div class="stat-value" id="success-rate">0%</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Active Source</div>
                        <div class="stat-value" id="active-source">None</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Errors</div>
                        <div class="stat-value" id="error-count">0</div>
                    </div>
                </div>
                <div class="diagnostic-details" style="margin-top: 15px;">
                    <div class="diagnostic-row">
                        <span class="diagnostic-label">Last Error:</span>
                        <span class="diagnostic-value error-value" id="last-error">None</span>
                    </div>
                    <div class="diagnostic-row">
                        <span class="diagnostic-label">Retry Count:</span>
                        <span class="diagnostic-value" id="retry-count">0</span>
                    </div>
                    <div class="diagnostic-row">
                        <span class="diagnostic-label">Loading Tiles:</span>
                        <span class="diagnostic-value" id="loading-tiles">0</span>
                    </div>
                </div>
            </div>

            <div class="debug-panel">
                <div class="debug-title">Source Validation</div>
                <div class="source-list" id="source-list">
                    <div class="source-item">
                        <span class="status-indicator status-idle"></span>
                        <span>Loading sources...</span>
                    </div>
                </div>
                <button onclick="validateAllSources()" style="margin-top: 10px;">Validate All Sources</button>
            </div>

            <div class="debug-panel">
                <div class="debug-title">Debug Log</div>
                <button onclick="clearLog()">Clear Log</button>
                <div id="log" class="log-panel"></div>
            </div>
        </div>

        <div id="map"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ol@8.2.0/dist/ol.js"></script>
    <script>
        // WeatherRadarCore class - inline implementation
        class WeatherRadarCore extends EventTarget {
            constructor(config = {}) {
                super();
                this.map = null;
                this.initialized = false;
                this.layers = new Map();
                this.controls = new Map();
                this.errors = [];

                this.config = {
                    target: config.target || 'map',
                    center: config.center || [-98.5795, 39.8283],
                    zoom: config.zoom || 4,
                    minZoom: config.minZoom || 2,
                    maxZoom: config.maxZoom || 16,
                    projection: config.projection || 'EPSG:3857',
                    basemap: config.basemap || 'osm',
                    radarOpacity: config.radarOpacity || 0.8,
                    enableGeolocation: config.enableGeolocation !== false,
                    enableControls: config.enableControls !== false,
                    debug: config.debug || false,
                    ...config
                };

                console.log('🌦️ WeatherRadarCore constructor initialized');
            }

            async initialize() {
                try {
                    console.log('🚀 Starting weather radar core initialization...');

                    this.map = new ol.Map({
                        target: this.config.target,
                        view: new ol.View({
                            center: ol.proj.fromLonLat(this.config.center),
                            zoom: this.config.zoom,
                            minZoom: this.config.minZoom,
                            maxZoom: this.config.maxZoom
                        }),
                        layers: []
                    });

                    this.initialized = true;
                    console.log('✅ Map initialized successfully');
                    return this.map;
                } catch (error) {
                    console.error('❌ Map initialization failed:', error);
                    throw error;
                }
            }
        }

        // LayerManager class - inline implementation
        class LayerManager extends EventTarget {
            constructor(map, config = {}) {
                super();
                this.map = map;
                this.config = config;
                this.debug = config.debug || false;
                this.layers = new Map();

                this.initializeBaseLayers();
                this.initializeRadarLayer();
            }

            initializeBaseLayers() {
                const streetLayer = new ol.layer.Tile({
                    source: new ol.source.OSM(),
                    visible: true,
                    zIndex: 0
                });
                this.layers.set('street', streetLayer);
                this.map.addLayer(streetLayer);

                const satelliteLayer = new ol.layer.Tile({
                    source: new ol.source.XYZ({
                        url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                        attributions: 'Source: Esri, DigitalGlobe, GeoEye, Earthstar Geographics'
                    }),
                    visible: false,
                    zIndex: 0
                });
                this.layers.set('satellite', satelliteLayer);
                this.map.addLayer(satelliteLayer);
            }

            async initializeRadarLayer() {
                try {
                    if (this.debug) {
                        console.log('Initializing NEXRAD radar layer...');
                    }

                    const radarLayer = new ol.layer.Tile({
                        source: new ol.source.XYZ({
                            url: 'https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/nexrad-n0q-900913/{z}/{x}/{y}.png',
                            attributions: '© Iowa Environmental Mesonet',
                            crossOrigin: 'anonymous'
                        }),
                        visible: true,
                        opacity: 0.7,
                        zIndex: 1,
                        className: 'nexrad-radar-layer'
                    });

                    this.layers.set('radar', radarLayer);
                    this.map.addLayer(radarLayer);

                    if (this.debug) {
                        console.log('✅ Successfully initialized NEXRAD radar layer');
                    }

                    return radarLayer;

                } catch (error) {
                    console.error('❌ Failed to initialize radar layer:', error);
                    throw error;
                }
            }

            setBaseLayer(type) {
                this.layers.get('street').setVisible(false);
                this.layers.get('satellite').setVisible(false);

                const layer = this.layers.get(type);
                if (layer) {
                    layer.setVisible(true);
                    if (this.debug) {
                        console.log('Switched to ' + type + ' base layer');
                    }
                }
            }
        }

        // RadarController class - inline implementation
        class RadarController extends EventTarget {
            constructor(map, layerManager, config = {}) {
                super();
                this.map = map;
                this.layerManager = layerManager;
                this.config = config;
                this.debugMode = config.debug || false;
                this.currentSourceId = 'iem';

                this.tileLoadStats = {
                    attempted: 0,
                    successful: 0,
                    failed: 0,
                    lastError: null,
                    retryCount: 0
                };

                this.nexradSources = [
                    {
                        id: 'iem',
                        name: 'Iowa State Mesonet',
                        url: 'https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/nexrad-n0q-900913/{z}/{x}/{y}.png',
                        attribution: '© Iowa Environmental Mesonet',
                        type: 'xyz'
                    },
                    {
                        id: 'noaa',
                        name: 'NOAA nowCOAST',
                        url: 'https://nowcoast.noaa.gov/arcgis/services/nowcoast/radar_meteo_imagery_nexrad_time/MapServer/WMSServer',
                        attribution: '© NOAA NowCOAST',
                        type: 'wms'
                    }
                ];

                this.sourceStats = {};
                this.updateSourceStats();
            }

            async initializeWithDiagnostics() {
                if (this.debugMode) {
                    console.log('Initializing NEXRAD radar with diagnostics...');
                }

                try {
                    const source = this.nexradSources[0];
                    const tileSource = new ol.source.XYZ({
                        url: source.url,
                        attributions: source.attribution,
                        crossOrigin: 'anonymous'
                    });

                    const self = this;
                    tileSource.on('tileloadstart', function() {
                        self.tileLoadStats.attempted++;
                        self.updateSourceStats();
                    });

                    tileSource.on('tileloadend', function() {
                        self.tileLoadStats.successful++;
                        self.updateSourceStats();
                    });

                    tileSource.on('tileloaderror', function(event) {
                        self.tileLoadStats.failed++;
                        self.tileLoadStats.lastError = 'Tile load failed at z:' + event.tile.tileCoord[0] + ', x:' + event.tile.tileCoord[1] + ', y:' + event.tile.tileCoord[2];
                        self.updateSourceStats();
                    });

                    const radarLayer = this.layerManager.layers.get('radar');
                    if (radarLayer) {
                        radarLayer.setSource(tileSource);
                        if (this.debugMode) {
                            console.log('Updated existing radar layer with new source');
                        }
                    }

                    if (this.debugMode) {
                        console.log('✅ NEXRAD radar initialization successful');
                    }

                } catch (error) {
                    this.tileLoadStats.lastError = error.message;
                    console.error('❌ NEXRAD radar initialization failed:', error);
                    throw error;
                }
            }

            updateSourceStats() {
                const stats = this.tileLoadStats;
                const total = stats.attempted;
                const success = stats.successful;
                const failed = stats.failed;
                const loading = total - (success + failed);

                this.sourceStats = {};
                this.sourceStats[this.nexradSources[0].id] = {
                    name: this.nexradSources[0].name,
                    stats: {
                        loaded: success,
                        errors: failed,
                        loading: loading,
                        retryCount: this.tileLoadStats.retryCount || 0,
                        lastError: this.tileLoadStats.lastError
                    }
                };
            }

            getDiagnostics() {
                return {
                    sourceStats: this.sourceStats
                };
            }

            toggleVisibility() {
                const radarLayer = this.layerManager.layers.get('radar');
                if (radarLayer) {
                    const visible = !radarLayer.getVisible();
                    radarLayer.setVisible(visible);
                    return visible;
                }
                return false;
            }

            setOpacity(opacity) {
                const radarLayer = this.layerManager.layers.get('radar');
                if (radarLayer) {
                    radarLayer.setOpacity(opacity);
                }
            }
        }

        // Global variables for diagnostic access
        window.diagnostics = {
            core: null,
            layerManager: null,
            radarController: null
        };

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toISOString().substr(11, 8);
            let color = '#00ff00';
            if (type === 'error') {
                color = '#ff0000';
            } else if (type === 'warning') {
                color = '#ffff00';
            }

            logEl.innerHTML += '<div style="color: ' + color + '">[' + timestamp + '] ' + message + '</div>';
            logEl.scrollTop = logEl.scrollHeight;
            console.log('[' + timestamp + '] ' + message);
        }

        async function initializeSystem() {
            try {
                updateStatus('system', 'loading');
                log('Initializing weather radar system...');

                // Initialize core with diagnostic configuration
                const core = new WeatherRadarCore({
                    target: 'map',
                    center: [-98.5795, 39.8283],
                    zoom: 4,
                    debug: true,
                    minZoom: 2,
                    maxZoom: 16,
                    radarOpacity: 0.7,
                    enableGeolocation: true
                });

                log('Initializing map core...');
                await core.initialize();
                window.diagnostics.core = core;
                log('✅ Map core initialized');

                // Initialize layer manager with base layers
                log('Initializing layer manager...');
                const layerManager = new LayerManager(core.map, {
                    debug: true,
                    defaultBaseLayer: 'street'
                });
                window.diagnostics.layerManager = layerManager;
                log('✅ Layer manager initialized');

                // Initialize radar controller with settings
                log('Initializing radar controller...');
                const radarController = new RadarController(core.map, layerManager, {
                    debug: true,
                    updateInterval: 300000, // 5 minutes
                    maxCacheAge: 3600000 // 1 hour
                });
                window.diagnostics.radarController = radarController;
                log('✅ Radar controller initialized');

                // Set up diagnostic updates
                setInterval(updateDiagnostics, 1000);

                // Set up opacity control
                document.getElementById('opacity').addEventListener('input', function(e) {
                    const opacity = e.target.value / 100;
                    if (window.diagnostics.radarController) {
                        window.diagnostics.radarController.setOpacity(opacity);
                    }
                    document.getElementById('opacity-value').textContent = e.target.value + '%';
                });

                updateStatus('system', 'success');
                log('✅ System initialized successfully');

                // Initialize radar layer
                await testRadarSources();

            } catch (error) {
                updateStatus('system', 'error');
                log('❌ Initialization failed: ' + error.message, 'error');
                console.error(error);
            }
        }

        window.testRadarSources = async function() {
            try {
                updateStatus('radar', 'loading');
                log('Testing radar sources...');

                await window.diagnostics.radarController.initializeWithDiagnostics();

                updateStatus('radar', 'success');
                log('✅ Radar layer initialized successfully');

            } catch (error) {
                updateStatus('radar', 'error');
                log('❌ Radar test failed: ' + error.message, 'error');
                console.error(error);
            }
        };

        window.reloadRadarLayer = async function() {
            try {
                updateStatus('radar', 'loading');
                log('Reloading radar layer...');

                const controller = window.diagnostics.radarController;
                await controller.initializeWithDiagnostics();

                updateStatus('radar', 'success');
                log('✅ Radar layer reloaded successfully');

            } catch (error) {
                updateStatus('radar', 'error');
                log('❌ Radar reload failed: ' + error.message, 'error');
                console.error(error);
            }
        };

        window.toggleRadar = function() {
            const controller = window.diagnostics.radarController;
            const visible = controller.toggleVisibility();
            log('Radar visibility set to: ' + visible);
        };

        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
            log('Log cleared');
        };

        function updateStatus(type, status) {
            const indicator = document.getElementById(type + '-status');
            indicator.className = 'status-indicator status-' + status;
        }

        function updateDiagnostics() {
            try {
                const { radarController } = window.diagnostics;
                if (!radarController) return;

                const stats = radarController.getDiagnostics();
                if (!stats) return;

                // Update system info
                const sysInfo = document.getElementById('system-info');
                sysInfo.textContent = 'OpenLayers ' + ol.util.VERSION;

                // Update statistics
                for (const sourceId in stats.sourceStats) {
                    const sourceStats = stats.sourceStats[sourceId];

                    document.getElementById('tiles-loaded').textContent =
                        sourceStats.stats.loaded;

                    const successRate = sourceStats.stats.loaded + sourceStats.stats.errors === 0 ? 0 :
                        Math.round((sourceStats.stats.loaded /
                            (sourceStats.stats.loaded + sourceStats.stats.errors)) * 100);

                    document.getElementById('success-rate').textContent =
                        successRate + '%';

                    document.getElementById('active-source').textContent =
                        sourceStats.name;

                    document.getElementById('error-count').textContent =
                        sourceStats.stats.errors;

                    // Update additional diagnostics
                    document.getElementById('last-error').textContent =
                        sourceStats.stats.lastError || 'None';
                    document.getElementById('retry-count').textContent =
                        sourceStats.stats.retryCount || 0;
                    document.getElementById('loading-tiles').textContent =
                        sourceStats.stats.loading || 0;

                    // Update status indicators
                    if (sourceStats.stats.loading > 0) {
                        updateStatus('radar', 'loading');
                    } else if (sourceStats.stats.errors > sourceStats.stats.loaded) {
                        updateStatus('radar', 'error');
                    } else if (sourceStats.stats.loaded > 0) {
                        updateStatus('radar', 'success');
                    }
                }

            } catch (error) {
                console.error('Diagnostic update failed:', error);
            }
        }

        // Source validation functions
        window.validateAllSources = async function() {
            const sourceList = document.getElementById('source-list');
            sourceList.innerHTML = ''; // Clear existing items

            const sources = window.diagnostics.radarController.nexradSources;
            for (const source of sources) {
                const sourceItem = createSourceItem(source);
                sourceList.appendChild(sourceItem);

                // Test the source
                await testSource(source, sourceItem);
            }
        }

        function createSourceItem(source) {
            const div = document.createElement('div');
            div.className = 'source-item';
            div.innerHTML =
                '<span class="status-indicator status-idle"></span>' +
                '<div class="source-details">' +
                    '<div>' + source.name + '</div>' +
                    '<div class="source-meta">' + source.url + '</div>' +
                    '<div class="source-error" style="display:none;"></div>' +
                '</div>' +
                '<button class="test-button" onclick="testSingleSource(\'' + source.id + '\', this)">Test</button>';
            return div;
        }

        async function testSource(source, sourceItem) {
            const indicator = sourceItem.querySelector('.status-indicator');
            const errorDiv = sourceItem.querySelector('.source-error');

            indicator.className = 'status-indicator status-loading';
            errorDiv.style.display = 'none';

            try {
                // Test multiple zoom levels
                const zoomLevels = [4, 8, 12];
                for (const zoom of zoomLevels) {
                    const x = Math.floor(Math.random() * Math.pow(2, zoom));
                    const y = Math.floor(Math.random() * Math.pow(2, zoom));

                    const url = source.url
                        .replace('{z}', zoom)
                        .replace('{x}', x)
                        .replace('{y}', y);

                    const response = await fetch(url, { method: 'HEAD' });

                    if (!response.ok) {
                        throw new Error('HTTP ' + response.status + ' at zoom ' + zoom);
                    }

                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('image')) {
                        throw new Error('Invalid content type: ' + contentType);
                    }
                }

                indicator.className = 'status-indicator status-success';
                log('✅ Source "' + source.name + '" validated successfully');

            } catch (error) {
                indicator.className = 'status-indicator status-error';
                errorDiv.style.display = 'block';
                errorDiv.textContent = error.message;
                log('❌ Source "' + source.name + '" validation failed: ' + error.message, 'error');
            }
        }

        window.testSingleSource = async function(sourceId, button) {
            const sources = window.diagnostics.radarController.nexradSources;
            const source = sources.find(s => s.id === sourceId);
            const sourceItem = button.closest('.source-item');

            if (source) {
                await testSource(source, sourceItem);
            }
        }

        // Initialize on load
        window.addEventListener('load', initializeSystem);
    </script>
</body>
</html>
